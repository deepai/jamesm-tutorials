

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Genesis &mdash; jamesm-tutorials v2.0.0 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="jamesm-tutorials v2.0.0 documentation" href="index.html" />
    <link rel="next" title="The Screen" href="the_screen.html" />
    <link rel="prev" title="Environment setup" href="environment_setup.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="the_screen.html" title="The Screen"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="environment_setup.html" title="Environment setup"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">jamesm-tutorials v2.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="genesis">
<h1>Genesis<a class="headerlink" href="#genesis" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-boot-code">
<h2>The boot code<a class="headerlink" href="#the-boot-code" title="Permalink to this headline">¶</a></h2>
<p>OK, It&#8217;s time for some code! Although the brunt of our kernel will be written in C, there are certain things that we just <em>must</em> use assembly for. One of those is the initial boot code.</p>
<p>Here we go:</p>
<div class="highlight-nasm"><div class="highlight"><pre><span class="c1">;</span>
<span class="c1">; boot.s -- Kernel start location. Also defines multiboot header.</span>
<span class="c1">;           Based on Bran&#39;s kernel development tutorial file start.asm</span>
<span class="c1">;</span>

<span class="no">MBOOT_PAGE_ALIGN</span><span class="kd">    equ</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span>    <span class="c1">; Load kernel and modules on a page boundary</span>
<span class="no">MBOOT_MEM_INFO</span><span class="kd">      equ</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span>    <span class="c1">; Provide your kernel with memory info</span>
<span class="no">MBOOT_HEADER_MAGIC</span><span class="kd">  equ</span> <span class="mh">0x1BADB002</span> <span class="c1">; Multiboot Magic value</span>
<span class="c1">; NOTE: We do not use MBOOT_AOUT_KLUDGE. It means that GRUB does not</span>
<span class="c1">; pass us a symbol table. GRUB will also require our kernel be in elf32 format.</span>
<span class="no">MBOOT_HEADER_FLAGS</span><span class="kd">  equ</span> <span class="nv">MBOOT_PAGE_ALIGN</span> <span class="o">|</span> <span class="nv">MBOOT_MEM_INFO</span>
<span class="no">MBOOT_CHECKSUM</span><span class="kd">      equ</span> <span class="o">-</span><span class="p">(</span><span class="nv">MBOOT_HEADER_MAGIC</span> <span class="o">+</span> <span class="nv">MBOOT_HEADER_FLAGS</span><span class="p">)</span>

<span class="k">bits</span> <span class="mi">32</span>                         <span class="c1">; All instructions should be 32-bit.</span>

<span class="k">section</span> <span class="nv">.text</span>

<span class="k">global</span> <span class="nv">mboot</span>                    <span class="c1">; Make &#39;mboot&#39; accessible from C.</span>

<span class="nl">mboot:</span>
    <span class="kd">dd</span>  <span class="nv">MBOOT_HEADER_MAGIC</span>      <span class="c1">; GRUB will search for this value on each</span>
                                <span class="c1">; 4-byte boundary in the first 8KB of your kernel file.</span>
    <span class="kd">dd</span>  <span class="nv">MBOOT_HEADER_FLAGS</span>      <span class="c1">; How GRUB should load your file / settings</span>
    <span class="kd">dd</span>  <span class="nv">MBOOT_CHECKSUM</span>          <span class="c1">; To ensure that the above values are correct</span>
    
<span class="k">global</span> <span class="nv">start</span><span class="p">:</span><span class="nv">function</span> <span class="nv">start.end</span><span class="o">-</span><span class="nv">start</span> <span class="c1">; Kernel entry point.</span>
<span class="k">extern</span> <span class="nv">main</span>                     <span class="c1">; This is the entry point of our C code</span>

<span class="nl">start:</span>
    <span class="nf">push</span> <span class="nb">ebx</span>                  	<span class="c1">; Push a pointer to the multiboot info structure.</span>

    <span class="nf">mov</span> <span class="nb">ebp</span><span class="p">,</span> <span class="mi">0</span>                  <span class="c1">; Initialise the base pointer to zero so we can terminate stack traces</span>
                                <span class="c1">; here.</span>
    <span class="nf">mov</span> <span class="nb">esp</span><span class="p">,</span> <span class="nv">stack</span>              <span class="c1">; Set up our own stack.</span>

    <span class="nf">cli</span>                         <span class="c1">; Disable interrupts.</span>
    <span class="nf">call</span> <span class="nv">main</span>                   <span class="c1">; call our main() function.</span>
    <span class="nf">jmp</span> <span class="kc">$</span>                       <span class="c1">; Enter an infinite loop, to stop the processor</span>
<span class="nl">.end:</span>                           <span class="c1">; from executing whatever rubbish is in the memory</span>
                                <span class="c1">; after our kernel!</span>

<span class="k">section</span> <span class="nv">.bss</span>
    <span class="kd">resb</span> <span class="mi">32768</span>
<span class="nl">stack:</span>
</pre></div>
</div>
</div>
<div class="section" id="understanding-the-boot-code">
<h2>Understanding the boot code<a class="headerlink" href="#understanding-the-boot-code" title="Permalink to this headline">¶</a></h2>
<p>There&#8217;s actually only a few lines of code in that snippet:</p>
<div class="highlight-nasm"><div class="highlight"><pre><span class="nf">push</span> <span class="nb">ebx</span>
<span class="nf">mov</span>  <span class="nb">ebp</span><span class="p">,</span> <span class="mi">0</span>
<span class="nf">mov</span> <span class="nb">esp</span><span class="p">,</span> <span class="nv">stack</span>
<span class="nf">cli</span>
<span class="nf">call</span> <span class="nv">main</span>
<span class="nf">jmp</span> <span class="kc">$</span>
</pre></div>
</div>
<p>We&#8217;ll come back to that later. The rest of the file has to to with the <em>multiboot header</em>.</p>
<div class="section" id="multiboot">
<h3>Multiboot<a class="headerlink" href="#multiboot" title="Permalink to this headline">¶</a></h3>
<p>Multiboot is a standard to which GRUB expects a kernel to comply. It is a way for the bootloader to</p>
<ol class="arabic simple">
<li>Know exactly what environment the kernel wants/needs when it boots.</li>
<li>Allow the kernel to query the environment it is in.</li>
</ol>
<p>So, for example, if your kernel needs to be loaded in a specific VESA mode (which is a bad idea, by the way), you can inform the bootloader of this and it can take care of it for you.</p>
<p>To make your kernel multiboot compatible you need to add a header structure somewhere in your kernel (Actually, the header must be in the first 8KB of the kernel). Usefully, there is a NASM command that lets us embed specific constants in our code - &#8216;dd&#8217;. These lines:</p>
<div class="highlight-nasm"><div class="highlight"><pre><span class="kd">dd</span>  <span class="nv">MBOOT_HEADER_MAGIC</span>      <span class="c1">; GRUB will search for this value on each</span>
                            <span class="c1">; 4-byte boundary in the first 8KB of your kernel file</span>
<span class="kd">dd</span>  <span class="nv">MBOOT_HEADER_FLAGS</span>      <span class="c1">; How GRUB should load your file / settings</span>
<span class="kd">dd</span>  <span class="nv">MBOOT_CHECKSUM</span>          <span class="c1">; To ensure that the above values are correct</span>
</pre></div>
</div>
<p>do just that. The MBOOT_* constants are defined above.</p>
<dl class="docutils">
<dt>MBOOT_HEADER_MAGIC</dt>
<dd>A magic number. This identifies the kernel as multiboot-compatible.</dd>
<dt>MBOOT_HEADER_FLAGS</dt>
<dd>A field of flags. We ask for GRUB to page-align all kernel sections (MBOOT_PAGE_ALIGN) and also to give us some memory information (MBOOT_MEM_INFO). Note that some tutorials also use MBOOT_AOUT_KLUDGE. As we are using the ELF file format, this hack is not necessary, and adding it stops GRUB giving you your symbol table when you boot up.</dd>
<dt>MBOOT_CHECKSUM</dt>
<dd>This field is defined such that when the magic number, the flags and this are added together, the total must be zero. It is for error checking.</dd>
</dl>
<p>On bootup, GRUB will load a pointer to another information structure into the EBX register. This can be used to query the environment GRUB set up for us.</p>
<p>Taken directly from the multiboot specification, the information structure looks like this:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">mem_lower</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">mem_upper</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">boot_device</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">cmdline</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">mods_count</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">mods_addr</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">num</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">shndx</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">mmap_length</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">mmap_addr</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">drives_length</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">drives_addr</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">config_table</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">boot_loader_name</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">apm_table</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">vbe_control_info</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">vbe_mode_info</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">vbe_mode</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">vbe_interface_seg</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">vbe_interface_off</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">vbe_interface_len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">multiboot_t</span><span class="p">;</span>
</pre></div>
</div>
<p>We&#8217;ll explain fields as we come to them in later chapters, but important to note is that I&#8217;ve used standard C typedefs for 32-bit unsigned integers. We don&#8217;t get these typedefs as standard with the CFLAGS we use, so we have to define them ourselves. This will help with writing portable and readable code.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">// common.h -- Defines typedefs and some global functions.</span>
<span class="cp">//             From JamesM&#39;s kernel development tutorials.</span>

<span class="cp">#ifndef COMMON_H</span>
<span class="cp">#define COMMON_H</span>

<span class="c1">// Some standard typedefs, to standardise sizes across platforms.</span>
<span class="c1">// These typedefs are written for 32-bit X86.</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="kt">uint32_t</span><span class="p">;</span>
<span class="k">typedef</span>          <span class="kt">int</span>   <span class="kt">int32_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">uint16_t</span><span class="p">;</span>
<span class="k">typedef</span>          <span class="kt">short</span> <span class="kt">int16_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="kt">uint8_t</span><span class="p">;</span>
<span class="k">typedef</span>          <span class="kt">char</span>  <span class="kt">int8_t</span><span class="p">;</span>

<span class="cp">#endif </span><span class="c1">// COMMON_H</span>
</pre></div>
</div>
<div class="section" id="back-to-the-code-again">
<h4>Back to the code again...<a class="headerlink" href="#back-to-the-code-again" title="Permalink to this headline">¶</a></h4>
<p>So, immediately on bootup, the asm snippet tells the CPU to push the contents of EBX onto the stack, clear the stack frame pointer (this is to help debuggers and stack tracers - more in a later chapter) and disable interrupts. It then calls a function called &#8220;main&#8221;, then enter an infinite loop.</p>
<p>All is good, but the code won&#8217;t link yet. We haven&#8217;t defined main()!</p>
</div>
</div>
<div class="section" id="adding-some-c-code">
<h3>Adding some C code<a class="headerlink" href="#adding-some-c-code" title="Permalink to this headline">¶</a></h3>
<p>Interfacing C code and assembly is easy. You just need to know the calling convention used. GCC on x86 uses the cdecl calling convention:</p>
<ul class="simple">
<li>All parameters to a function are passed on the stack.</li>
<li>The parameters are pushed <em>right-to-left</em>.</li>
<li>The return value of a function is in EAX.</li>
<li>The caller cleans up the stack after the call.</li>
</ul>
<p>... so the function call:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</pre></div>
</div>
<p>Becomes</p>
<div class="highlight-nasm"><div class="highlight"><pre><span class="nf">push</span> <span class="p">[</span><span class="nv">c</span><span class="p">]</span>
<span class="nf">push</span> <span class="p">[</span><span class="nv">b</span><span class="p">]</span>
<span class="nf">push</span> <span class="p">[</span><span class="nv">a</span><span class="p">]</span>
<span class="nf">call</span> <span class="nv">func</span>
<span class="nf">mov</span> <span class="p">[</span><span class="nv">d</span><span class="p">],</span> <span class="nb">eax</span>
<span class="nf">add</span> <span class="nb">esp</span><span class="p">,</span> <span class="mi">12</span>     <span class="c1">; The caller (us) must clean up the stack.</span>
</pre></div>
</div>
<p>So you can see that in our asm snippet above, that &#8216;push ebx&#8217; is actually passing
a parameter to the function &#8216;main()&#8217;</p>
<div class="section" id="the-c-code">
<h4>The C code<a class="headerlink" href="#the-c-code" title="Permalink to this headline">¶</a></h4>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">// main.c -- Defines the C-code kernel entry point, calls initialisation routines.</span>
<span class="cp">//           Made for JamesM&#39;s tutorials &lt;www.jamesmolloy.co.uk&gt;</span>
<span class="cp">#include &quot;multiboot.h&quot;</span>
<span class="cp">#include &quot;common.h&quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="n">multiboot_t</span> <span class="o">*</span><span class="n">mboot_ptr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// All our initialisation calls will go in here.</span>
  <span class="k">return</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here&#8217;s our first incarnation of the main() function. As you can see,
we&#8217;ve made it take just one parameter - a pointer to a multiboot
struct.</p>
<p>All the function does is return a constant - 0xdeadbeef. That constant
is unusual enough that it should stand out at you when we run the
program in a second.</p>
</div>
</div>
<div class="section" id="compiling-linking-and-running">
<h3>Compiling, linking and running!<a class="headerlink" href="#compiling-linking-and-running" title="Permalink to this headline">¶</a></h3>
<p>OK, you should now be able to compile, link and run your kernel!</p>
<div class="highlight-bash"><div class="highlight"><pre>make clean  <span class="c"># Removes all temporary files. Ignore any errors here.</span>
make        <span class="c"># Compiles, assembles and links, then updates the floppy disk image.</span>
make bochs  <span class="c"># This will run bochs for you.</span>
</pre></div>
</div>
<p>That should cause bochs to boot, you&#8217;ll see GRUB for a few seconds
then the kernel will run. It doesn&#8217;t actually <em>do</em> anything, so
it&#8217;ll just freeze, saying &#8216;starting up...&#8217;.</p>
<p>If you open bochsout.txt, at the bottom you should see something like:</p>
<div class="highlight-text"><div class="highlight"><pre>00074621500i[CPU  ] | EAX=deadbeef  EBX=0002d000  ECX=0001edd0 EDX=00000001
00074621500i[CPU  ] | ESP=00067ec8  EBP=00067ee0  ESI=00053c76 EDI=00053c77
00074621500i[CPU  ] | IOPL=0 id vip vif ac vm rf nt of df if tf sf zf af pf cf
00074621500i[CPU  ] | SEG selector     base    limit G D
00074621500i[CPU  ] | SEG sltr(index|ti|rpl)     base    limit G D
00074621500i[CPU  ] |  CS:0008( 0001| 0|  0) 00000000 000fffff 1 1
00074621500i[CPU  ] |  DS:0010( 0002| 0|  0) 00000000 000fffff 1 1
00074621500i[CPU  ] |  SS:0010( 0002| 0|  0) 00000000 000fffff 1 1
00074621500i[CPU  ] |  ES:0010( 0002| 0|  0) 00000000 000fffff 1 1
00074621500i[CPU  ] |  FS:0010( 0002| 0|  0) 00000000 000fffff 1 1
00074621500i[CPU  ] |  GS:0010( 0002| 0|  0) 00000000 000fffff 1 1
00074621500i[CPU  ] | EIP=00100027 (00100027)
00074621500i[CPU  ] | CR0=0x00000011 CR1=0 CR2=0x00000000
00074621500i[CPU  ] | CR3=0x00000000 CR4=0x00000000
00074621500i[CPU  ] &gt;&gt; jmp .+0xfffffffe (0x00100027) : EBFE
</pre></div>
</div>
<img alt="_images/genesis_bochs.png" src="_images/genesis_bochs.png" />
<p>Notice what the value of EAX is? 0xdeadbeef - the return value of
main(). Congratulations, you now have a multiboot compatible assembly
trampoline, and you&#8217;re ready to start printing to the screen!</p>
<p>Sample code for this tutorial can be found <tt class="xref download docutils literal"><span class="pre">here</span></tt></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Genesis</a><ul>
<li><a class="reference internal" href="#the-boot-code">The boot code</a></li>
<li><a class="reference internal" href="#understanding-the-boot-code">Understanding the boot code</a><ul>
<li><a class="reference internal" href="#multiboot">Multiboot</a><ul>
<li><a class="reference internal" href="#back-to-the-code-again">Back to the code again...</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-some-c-code">Adding some C code</a><ul>
<li><a class="reference internal" href="#the-c-code">The C code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compiling-linking-and-running">Compiling, linking and running!</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="environment_setup.html"
                        title="previous chapter">Environment setup</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="the_screen.html"
                        title="next chapter">The Screen</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/genesis.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="the_screen.html" title="The Screen"
             >next</a> |</li>
        <li class="right" >
          <a href="environment_setup.html" title="Environment setup"
             >previous</a> |</li>
        <li><a href="index.html">jamesm-tutorials v2.0.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, James Molloy.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>